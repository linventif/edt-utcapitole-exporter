events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Add ICS MIME type
    types {
        text/calendar ics;
    }

    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;
        index index.html;

        # Custom error pages
        error_page 404 /404.html;
        location = /404.html {
            internal;
        }

        # CORS headers for calendar subscriptions
        add_header Access-Control-Allow-Origin *;

        # Dashboard
        location = / {
            try_files /index.html =404;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # Serve ICS files
        location /calendars/ {
            alias /usr/share/nginx/html/calendars/;
            autoindex on;
            autoindex_format json;
            
            # Force correct MIME type for ICS files
            types {
                text/calendar ics;
            }
            
            # Additional headers for calendar clients and Cloudflare
            add_header Content-Type "text/calendar; charset=utf-8";
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
            add_header Pragma "no-cache";
            add_header Expires "0";
            add_header CF-Cache-Status "DYNAMIC";
            add_header CDN-Cache-Control "no-cache";
        }
    }
}